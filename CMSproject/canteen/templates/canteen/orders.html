<!DOCTYPE html>
<html lang="en">
<head>
    {%load static%}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'canteen/css/s_canteen.css' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Alegreya SC:wght@400&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu Mono:wght@400&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Font Awesome 5 Free:wght@400&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" />

    <title>Orders</title>
    <style>
        .orders{
            display: flex;
            flex-direction: column;
            margin: 10px;
            padding: 5px;
            background-color: #a7b9c6;
            width:40%;
            border-radius: 10%;
            height: fit-content;
            align-items: center;
            justify-content: space-around;
        }
        #displayOrder{
            display: flex;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <picture class="logoContainer"> 
             <!-- college ko logo -->
            <img src="/media/collegeLogo.png/" alt="logo">
        </picture>
        {% comment %} <div class="searchContainer">
            <input type="text" placeholder="Search...">
            <!-- <button class="search_button"> -->
            </button>
        </div> {% endcomment %}
        <div class="userProfileContainer" onclick="showProfileOptions()">
            <img src="{{admin_instance.profile_picture.url}}" alt="profilePic" class="profilePic">
            <div class="fullName" style="font-size: 1.2rem;">{{admin_instance.name}}</div>
            <div class="profileOptions">
                <ul>
                    <li>
                        <a href="#">Account</a>
                    </li>
                    <li>
                        <a href="#">Settings</a>
                    </li>
                    <li>
                        <a href="#">Privacy</a>
                    </li>
                    <li>
                        <a href="{% url 'logout' %}">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <aside class="aside">
        <ul class="pageLinks">
            <li class="pageLink">
                <a href="{% url 's_canteen' %}">Menu</a>
            </li>
            <li class="pageLink">
                <a class="activePage" href="{% url 'orders'  %}">Orders</a>
            </li>
            <li class="pageLink">
                <a href="{% url 'sales'  %}">Sales</a>
            </li>
          
        </ul>
        {% comment %} <div class="contactInfo">
            <dl>
                <dt>P.O.Box:</dt>
                <dd>3928, Kalimati, Kathmandu</dd>
            
                <dt>Email:</dt>
                <dd><a href="mailto:info@kecktm.edu.np">info@kecktm.edu.np</a></dd>
            
                <dt>Contact:</dt>
                <dd>01-5372833, 9863035297, 01-5372833, 01-5372653</dd>
            </dl>
        </div> {% endcomment %}
    </aside>
    <main class="main">
        <div class="top">
            <h2>CANTEEN</h2>
            <div class="notice">
                <div class="notification" onclick="togglenoti('batta')">
                    <img height="40px" width="40px" src="/media/bell.png" alt=""><span class="span">{{ admin_notifications.count }}</span>
                </div>
                <div class="not-box" id="batta">
                    <div class="notification-item">
                        <i>view notifications here</i>
                    </div>
                    <div class="notification-item">
                        <h4>Dummy notification</h4>
                        <p>Dummy notification content</p>
                    </div>
                    {% for notification in admin_notifications %}
                    <div class="notification-item" data-notification-id="{{ notification.id }}">
                        <h4>{{ notification.title }}</h4>
                        <p>{{ notification.content }}</p>
                        <!-- Add more details as needed -->
                    </div>
                {% endfor %}
                </div>
            </div>
        </div>
        <input type="hidden" name="csrfmiddlewaretoken" value="{% csrf_token %}">
        <div id="displayOrder">
            {% for order in order_items %}
            {% if order.order.status == "pending" %}
                <div class="orders">
                    <p>Order: {{ order.order.order_name.name }}</p>
                    <img height="50%" width="50%" src="{{ order.order.order_name.image.url }}" alt="{{ order.order.order_name.name }} Image">
                    <p>Quantity: {{ order.order.quantity }}</p>
                    <p>Created At: {{ order.order.created_at }}</p>
                    <p>Customer: {{ order.customer_name }}</p>
                    <img height="20%" width="20%" src="{{ order.customer_img }}" alt="{{ order.customer_name }} Image">
                    <div>
                        <button onclick="confirmOrder(this)" data-order-id="{{order.order.id}}">Confirm Order</button>
                        <button onclick="rejectOrder(this)" data-order-id="{{order.order.id}}">Reject Order</button>
                    </div>
                </div>
            {% endif %}
            {% if order.order.status == "in-progress" %}
                <div class="orders">
                    <p>Order: {{ order.order.order_name.name }}</p>
                    <img height="50%" width="50%" src="{{ order.order.order_name.image.url }}" alt="{{ order.order.order_name.name }} Image">
                    <p>Quantity: {{ order.order.quantity }}</p>
                    <p>Created At: {{ order.order.created_at }}</p>
                    <p>Customer: {{ order.customer_name }}</p>
                    <img height="20%" width="20%" src="{{ order.customer_img }}" alt="{{ order.customer_name }} Image">
                    <div>
                        <button onclick="OrderCompleted(this)" data-order-id="{{order.order.id}}">Order Completed!</button>
                    </div>
                </div>
            {% endif %}
            {% endfor %}
        </div>

    </main>
    <script>
        var confirmOrderurl = "{% url 'order_confirmed' %}";
        var OrderCompletedurl = "{% url 'order_completed' %}";
        var rejectOrderurl = "{% url 'order_rejected' %}";
            var apigetnotificationUrl = "{% url 'get_notifications' %}";
            var marknotificationUrl = "{% url 'mark_notifications_as_seen' %}";
            var notificationSound = new Audio('{% static "canteen/audio/notification.wav" %}');
            $(document).ready(function() {
                $('.notification').data('already-rendered', true);
            });
        
            function updateNotifications() {
                fetch(apigetnotificationUrl)  // Update with your actual API endpoint
                    .then(response => response.json())
                    .then(data => {
                        var notificationCount = data.notification_count;
                        var newNotifications = $(data.notification_html);  // Convert HTML to jQuery elements
        
                        // Filter out notifications that were present during the initial page load
                        newNotifications = newNotifications.filter(function () {
                            return !$(this).data('already-rendered');
                        });
                        if (newNotifications.length > 0) {
                            notificationSound.play();
                        }
        
                        // Update the UI with new notifications
                        $('#notificationCount').text(notificationCount);
                        
                        // Add the 'data-already-rendered' attribute to the new notifications
                        newNotifications.data('already-rendered', true);
        
                        // Wrap each new notification in a div with the appropriate class and data attribute
                        newNotifications.each(function() {
                            var notificationId = $(this).data('notification-id');
                            var notificationItem = $('<div class="notification-item" data-notification-id="' + notificationId + '"></div>');
                            notificationItem.append($(this));
                            $('#batta').append(notificationItem);
                        });
                    })
                    .catch(error => {
                        console.error('Error updating notifications:', error);
                    });
            }
        
            // Call the function every 20 seconds (adjust as needed)
            setInterval(updateNotifications, 20000);    
    </script> 
    <script src="{% static 'canteen/js/orders.js' %}"></script>
</body>
</html>
